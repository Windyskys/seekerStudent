<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SeekerAIæ™ºèƒ½å­¦ä¹ å¹³å° - æµ‹è¯„ç»“æœåˆ†æ</title>
    <link rel="stylesheet" href="css/styles.css">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .result-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--space-xl);
        }

        .result-header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            padding: var(--space-2xl);
            border-radius: var(--border-radius-lg);
            margin-bottom: var(--space-xl);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .result-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200px;
            height: 200px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        .result-title {
            font-size: var(--font-size-3xl);
            font-weight: 700;
            margin-bottom: var(--space-sm);
            position: relative;
            z-index: 1;
        }

        .result-subtitle {
            font-size: var(--font-size-lg);
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .result-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
        }

        .overview-card {
            background: var(--light-color);
            border-radius: var(--border-radius-lg);
            padding: var(--space-xl);
            box-shadow: 0 4px 20px var(--shadow-color);
            text-align: center;
            position: relative;
            transition: transform var(--transition-speed);
        }

        .overview-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 32px var(--shadow-hover);
        }

        .overview-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto var(--space-md);
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }

        .overview-value {
            font-size: var(--font-size-3xl);
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: var(--space-xs);
        }

        .overview-label {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            margin-bottom: var(--space-sm);
        }

        .overview-trend {
            font-size: var(--font-size-xs);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-xs);
        }

        .trend-up {
            color: var(--success-color);
        }

        .result-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: var(--space-xl);
            margin-bottom: var(--space-xl);
        }

        .analysis-section {
            background: var(--light-color);
            border-radius: var(--border-radius-lg);
            padding: var(--space-xl);
            box-shadow: 0 4px 20px var(--shadow-color);
            margin-bottom: var(--space-lg);
        }

        .section-title {
            font-size: var(--font-size-xl);
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: var(--space-lg);
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .title-icon {
            width: 32px;
            height: 32px;
            background: var(--primary-color);
            border-radius: var(--border-radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .knowledge-points {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-md);
        }

        .knowledge-point {
            background: var(--light-gray);
            border-radius: var(--border-radius);
            padding: var(--space-md);
            border-left: 4px solid var(--border-color);
            transition: all var(--transition-speed);
        }

        .knowledge-point.excellent {
            border-left-color: var(--success-color);
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.05) 0%, rgba(40, 167, 69, 0.02) 100%);
        }

        .knowledge-point.good {
            border-left-color: var(--primary-color);
            background: linear-gradient(135deg, rgba(107, 165, 57, 0.05) 0%, rgba(107, 165, 57, 0.02) 100%);
        }

        .knowledge-point.needs-improvement {
            border-left-color: var(--warning-color);
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.05) 0%, rgba(255, 193, 7, 0.02) 100%);
        }

        .point-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-sm);
        }

        .point-name {
            font-weight: 500;
            font-size: var(--font-size-sm);
        }

        .point-score {
            font-weight: 600;
            font-size: var(--font-size-sm);
        }

        .point-progress {
            height: 6px;
            background: var(--border-color);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: var(--space-sm);
        }

        .point-fill {
            height: 100%;
            border-radius: 3px;
            transition: width var(--transition-speed);
        }

        .excellent .point-fill {
            background: var(--success-color);
        }

        .good .point-fill {
            background: var(--primary-color);
        }

        .needs-improvement .point-fill {
            background: var(--warning-color);
        }

        .point-status {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
        }

        .ai-analysis {
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.05), rgba(139, 92, 246, 0.05));
            border: 1px solid rgba(79, 70, 229, 0.1);
            border-radius: var(--border-radius);
            padding: var(--space-lg);
        }

        .ai-content {
            line-height: 1.8;
            color: var(--text-color);
        }

        .recommendations {
            list-style: none;
            padding: 0;
        }

        .recommendation-item {
            background: var(--light-gray);
            border-radius: var(--border-radius);
            padding: var(--space-md);
            margin-bottom: var(--space-md);
            border-left: 4px solid var(--primary-color);
            display: flex;
            align-items: flex-start;
            gap: var(--space-md);
        }

        .rec-icon {
            width: 24px;
            height: 24px;
            background: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .chart-container {
            height: 300px;
            margin: var(--space-lg) 0;
            position: relative;
        }

        .action-buttons {
            display: flex;
            gap: var(--space-md);
            justify-content: center;
            margin-top: var(--space-xl);
        }

        .btn-large {
            padding: var(--space-md) var(--space-xl);
            font-size: var(--font-size-base);
            border-radius: var(--border-radius);
            border: none;
            cursor: pointer;
            transition: all var(--transition-speed);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            text-decoration: none;
            font-weight: 600;
        }

        .btn-primary-large {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
        }

        .btn-primary-large:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(107, 165, 57, 0.3);
        }

        .btn-secondary-large {
            background: var(--light-color);
            color: var(--text-color);
            border: 2px solid var(--border-color);
        }

        .btn-secondary-large:hover {
            border-color: var(--primary-color);
            background: rgba(107, 165, 57, 0.05);
        }

        .loading-section {
            text-align: center;
            padding: var(--space-3xl);
            color: var(--text-secondary);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto var(--space-lg);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .result-container {
                padding: var(--space-md);
            }

            .result-content {
                grid-template-columns: 1fr;
            }

            .overview-card {
                padding: var(--space-lg);
            }

            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- ä¾§è¾¹æ  -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <img src="img/logo.svg" alt="SeekerAI" style="height: 40px; width: auto;">
                </div>
                <button class="sidebar-toggle" id="sidebarToggle">
                    <i data-lucide="chevron-left"></i>
                </button>
            </div>
        </aside>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="main-content" id="mainContent">
            <div class="result-container">
                <!-- ç»“æœå¤´éƒ¨ -->
                <div class="result-header">
                    <h1 class="result-title">æµ‹è¯„ç»“æœåˆ†æ</h1>
                    <p class="result-subtitle">AIæ™ºèƒ½åˆ†ææ‚¨çš„æ•°å­¦å­¦ä¹ çŠ¶å†µ</p>
                </div>

                <!-- åŠ è½½çŠ¶æ€ -->
                <div class="loading-section" id="loadingSection">
                    <div class="loading-spinner"></div>
                    <p>AIæ­£åœ¨æ·±åº¦åˆ†ææ‚¨çš„æµ‹è¯„ç»“æœï¼Œè¯·ç¨å€™...</p>
                </div>

                <!-- ç»“æœå†…å®¹ -->
                <div id="resultContent" style="display: none;">
                    <!-- æ¦‚è§ˆå¡ç‰‡ -->
                    <div class="result-overview">
                        <div class="overview-card">
                            <div class="overview-icon" style="background: linear-gradient(135deg, var(--primary-color), var(--primary-light));">
                                <i data-lucide="target"></i>
                            </div>
                            <div class="overview-value" id="totalScore">85</div>
                            <div class="overview-label">ç»¼åˆå¾—åˆ†</div>
                            <div class="overview-trend trend-up">
                                <i data-lucide="trending-up" size="14"></i>
                                <span>è‰¯å¥½æ°´å¹³</span>
                            </div>
                        </div>

                        <div class="overview-card">
                            <div class="overview-icon" style="background: linear-gradient(135deg, var(--success-color), #20c997);">
                                <i data-lucide="check-circle"></i>
                            </div>
                            <div class="overview-value" id="correctRate">80%</div>
                            <div class="overview-label">æ­£ç¡®ç‡</div>
                            <div class="overview-trend trend-up">
                                <i data-lucide="trending-up" size="14"></i>
                                <span>è¶…è¶Š70%åŒå¹´çº§</span>
                            </div>
                        </div>

                        <div class="overview-card">
                            <div class="overview-icon" style="background: linear-gradient(135deg, var(--info-color), #00bcd4);">
                                <i data-lucide="clock"></i>
                            </div>
                            <div class="overview-value" id="avgTime">1:32</div>
                            <div class="overview-label">å¹³å‡ç”¨æ—¶</div>
                            <div class="overview-trend trend-up">
                                <i data-lucide="trending-up" size="14"></i>
                                <span>æ€è€ƒå……åˆ†</span>
                            </div>
                        </div>

                        <div class="overview-card">
                            <div class="overview-icon" style="background: linear-gradient(135deg, var(--warning-color), #fbbf24);">
                                <i data-lucide="brain"></i>
                            </div>
                            <div class="overview-value" id="difficulty">ä¸­ç­‰</div>
                            <div class="overview-label">é€‚åº”éš¾åº¦</div>
                            <div class="overview-trend trend-up">
                                <i data-lucide="trending-up" size="14"></i>
                                <span>å¯æŒ‘æˆ˜æ›´é«˜éš¾åº¦</span>
                            </div>
                        </div>
                    </div>

                    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
                    <div class="result-content">
                        <!-- å·¦ä¾§ï¼šè¯¦ç»†åˆ†æ -->
                        <div class="main-analysis">
                            <!-- çŸ¥è¯†ç‚¹æŒæ¡æƒ…å†µ -->
                            <div class="analysis-section">
                                <h2 class="section-title">
                                    <div class="title-icon">
                                        <i data-lucide="book-open"></i>
                                    </div>
                                    çŸ¥è¯†ç‚¹æŒæ¡æƒ…å†µ
                                </h2>
                                <div class="knowledge-points" id="knowledgePoints">
                                    <!-- åŠ¨æ€æ’å…¥çŸ¥è¯†ç‚¹ -->
                                </div>
                            </div>

                            <!-- AIæ™ºèƒ½åˆ†æ -->
                            <div class="analysis-section">
                                <h2 class="section-title">
                                    <div class="title-icon">
                                        <i data-lucide="brain"></i>
                                    </div>
                                    AIæ™ºèƒ½åˆ†æ
                                </h2>
                                <div class="ai-analysis">
                                    <div class="ai-content" id="aiAnalysisContent">
                                        <!-- AIåˆ†æå†…å®¹ -->
                                    </div>
                                </div>
                            </div>

                            <!-- å­¦ä¹ èƒ½åŠ›é›·è¾¾å›¾ -->
                            <div class="analysis-section">
                                <h2 class="section-title">
                                    <div class="title-icon">
                                        <i data-lucide="activity"></i>
                                    </div>
                                    å­¦ä¹ èƒ½åŠ›åˆ†æ
                                </h2>
                                <div class="chart-container">
                                    <canvas id="abilityChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- å³ä¾§ï¼šå»ºè®®å’Œè¡ŒåŠ¨ -->
                        <div class="sidebar-analysis">
                            <!-- å­¦ä¹ å»ºè®® -->
                            <div class="analysis-section">
                                <h2 class="section-title">
                                    <div class="title-icon">
                                        <i data-lucide="lightbulb"></i>
                                    </div>
                                    å­¦ä¹ å»ºè®®
                                </h2>
                                <ul class="recommendations" id="recommendations">
                                    <!-- åŠ¨æ€æ’å…¥å»ºè®® -->
                                </ul>
                            </div>

                            <!-- åç»­å­¦ä¹ è§„åˆ’ -->
                            <div class="analysis-section">
                                <h2 class="section-title">
                                    <div class="title-icon">
                                        <i data-lucide="map"></i>
                                    </div>
                                    å­¦ä¹ è§„åˆ’
                                </h2>
                                <div id="learningPlan">
                                    <!-- å­¦ä¹ è§„åˆ’å†…å®¹ -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ“ä½œæŒ‰é’® -->
                    <div class="action-buttons">
                        <a href="dashboard.html" class="btn-large btn-secondary-large">
                            <i data-lucide="home"></i>
                            è¿”å›é¦–é¡µ
                        </a>
                        <a href="progress.html" class="btn-large btn-primary-large">
                            <i data-lucide="target"></i>
                            æŸ¥çœ‹å­¦ä¹ è¿›åº¦
                        </a>
                        <button class="btn-large btn-primary-large" onclick="generateWhitepaper()">
                            <i data-lucide="file-text"></i>
                            ç”Ÿæˆå­¦æƒ…ç™½çš®ä¹¦
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        class AssessmentResult {
            constructor() {
                this.sessionId = this.getSessionId();
                this.resultData = null;
                this.chart = null;
                
                this.initializeElements();
                this.loadResult();
            }

            initializeElements() {
                this.loadingSection = document.getElementById('loadingSection');
                this.resultContent = document.getElementById('resultContent');
                this.totalScore = document.getElementById('totalScore');
                this.correctRate = document.getElementById('correctRate');
                this.avgTime = document.getElementById('avgTime');
                this.difficulty = document.getElementById('difficulty');
                this.knowledgePoints = document.getElementById('knowledgePoints');
                this.aiAnalysisContent = document.getElementById('aiAnalysisContent');
                this.recommendations = document.getElementById('recommendations');
                this.learningPlan = document.getElementById('learningPlan');
            }

            getSessionId() {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('sessionId') || 'demo_session';
            }

            async loadResult() {
                try {
                    // é¦–å…ˆå°è¯•ä»localStorageè·å–ç¼“å­˜çš„æŠ¥å‘Š
                    const cachedReport = localStorage.getItem('assessmentReport');
                    if (cachedReport) {
                        const report = JSON.parse(cachedReport);
                        localStorage.removeItem('assessmentReport'); // æ¸…é™¤ç¼“å­˜
                        this.resultData = this.formatReportData(report);
                        this.displayResult();
                        this.hideLoading();
                        return;
                    }

                    // å¦‚æœæ²¡æœ‰ç¼“å­˜ï¼Œä»APIè·å–
                    const response = await fetch(`/api/assessment/report/${this.sessionId}`);
                    const result = await response.json();
                    
                    if (result.success) {
                        this.resultData = this.formatReportData(result.report);
                    } else {
                        throw new Error('è·å–æŠ¥å‘Šå¤±è´¥');
                    }
                    
                    this.displayResult();
                    this.hideLoading();
                } catch (error) {
                    console.error('åŠ è½½æµ‹è¯„ç»“æœå¤±è´¥:', error);
                    
                    // å›é€€åˆ°ç¦»çº¿æ¨¡å¼ï¼Œä»localStorageè·å–åŸºç¡€æ•°æ®
                    const offlineResult = localStorage.getItem('assessmentResult');
                    if (offlineResult) {
                        const data = JSON.parse(offlineResult);
                        localStorage.removeItem('assessmentResult');
                        this.resultData = this.generateOfflineReport(data);
                        this.displayResult();
                        this.hideLoading();
                    } else {
                        // å¦‚æœéƒ½æ²¡æœ‰ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®
                        this.resultData = this.getDefaultMockResult();
                        this.displayResult();
                        this.hideLoading();
                    }
                }
            }

            formatReportData(report) {
                // å¤„ç†APIè¿”å›çš„æ•°æ®ï¼Œå¯èƒ½åŒ…å«JSONå­—ç¬¦ä¸²å­—æ®µ
                let strengths = [];
                let weaknesses = [];
                let recommendations = [];
                let learningPlan = {};

                try {
                    strengths = Array.isArray(report.strengths) ? report.strengths : JSON.parse(report.strengths || '[]');
                    weaknesses = Array.isArray(report.weaknesses) ? report.weaknesses : JSON.parse(report.weaknesses || '[]');
                    recommendations = Array.isArray(report.recommendations) ? report.recommendations : JSON.parse(report.recommendations || '[]');
                    learningPlan = typeof report.learning_plan === 'object' ? report.learning_plan : JSON.parse(report.learning_plan || '{}');
                } catch (e) {
                    console.warn('è§£æJSONå­—æ®µå¤±è´¥:', e);
                }

                const accuracy = report.total_questions > 0 ? 
                    (report.correct_count / report.total_questions * 100) : 
                    (report.overall_score || 75);
                    
                return {
                    overview: {
                        totalScore: report.overall_score || Math.round(accuracy),
                        correctRate: Math.round(accuracy),
                        avgTime: 90,
                        adaptiveDifficulty: accuracy >= 80 ? 'hard' : accuracy >= 60 ? 'medium' : 'easy'
                    },
                    knowledgePoints: this.generateKnowledgePointsFromData(accuracy),
                    abilities: this.generateAbilities(accuracy),
                    aiAnalysis: this.formatAIAnalysis(report, strengths, weaknesses),
                    recommendations: this.formatRecommendations(recommendations),
                    learningPlan: {
                        shortTerm: learningPlan.shortTerm || learningPlan.short_term || [
                            'æœ¬å‘¨ï¼šé‡ç‚¹å¤ä¹ è–„å¼±çŸ¥è¯†ç‚¹',
                            'ä¸‹å‘¨ï¼šåŠ å¼ºç›¸å…³é¢˜å‹ç»ƒä¹ '
                        ],
                        mediumTerm: learningPlan.mediumTerm || learningPlan.medium_term || [
                            'æœ¬æœˆï¼šå®Œæˆå½“å‰å•å…ƒçš„å…¨é¢å¤ä¹ ',
                            'ä¸‹æœˆï¼šå¼€å§‹ä¸‹ä¸€å•å…ƒçš„å­¦ä¹ '
                        ]
                    }
                };
            }

            formatAIAnalysis(report, strengths = [], weaknesses = []) {
                if (report.ai_analysis) {
                    return report.ai_analysis;
                }
                
                // å¦‚æœæ²¡æœ‰AIåˆ†æï¼Œæ ¹æ®ä¼˜åŠ¿å’Œä¸è¶³ç”Ÿæˆç®€å•åˆ†æ
                let analysis = `åŸºäºæœ¬æ¬¡æµ‹è¯„ç»“æœï¼Œæ‚¨åœ¨æ•°å­¦å­¦ä¹ æ–¹é¢è¡¨ç°å‡ºä»¥ä¸‹ç‰¹ç‚¹ï¼š<br><br>`;
                
                if (strengths.length > 0) {
                    analysis += `<strong>ä¼˜åŠ¿æ–¹é¢ï¼š</strong><br>`;
                    strengths.forEach(strength => {
                        analysis += `â€¢ ${strength}<br>`;
                    });
                    analysis += `<br>`;
                } else {
                    analysis += `<strong>ä¼˜åŠ¿æ–¹é¢ï¼š</strong><br>`;
                    analysis += `â€¢ åŸºç¡€çŸ¥è¯†æŒæ¡è¾ƒä¸ºæ‰å®<br>`;
                    analysis += `â€¢ å­¦ä¹ æ€åº¦è®¤çœŸï¼Œç­”é¢˜æ€è·¯æ¸…æ™°<br><br>`;
                }
                
                if (weaknesses.length > 0) {
                    analysis += `<strong>éœ€è¦æå‡çš„æ–¹é¢ï¼š</strong><br>`;
                    weaknesses.forEach(weakness => {
                        analysis += `â€¢ ${weakness}<br>`;
                    });
                    analysis += `<br>`;
                } else {
                    analysis += `<strong>éœ€è¦æå‡çš„æ–¹é¢ï¼š</strong><br>`;
                    analysis += `â€¢ å¯ä»¥é€‚å½“æé«˜è§£é¢˜é€Ÿåº¦<br>`;
                    analysis += `â€¢ å°è¯•æŒ‘æˆ˜æ›´é«˜éš¾åº¦çš„é¢˜ç›®<br><br>`;
                }
                
                analysis += `<strong>æ€»ä½“è¯„ä»·ï¼š</strong><br>ç»§ç»­ä¿æŒè‰¯å¥½çš„å­¦ä¹ ä¹ æƒ¯ï¼Œé’ˆå¯¹è–„å¼±ç¯èŠ‚åŠ å¼ºç»ƒä¹ ï¼Œç›¸ä¿¡æ‚¨çš„æ•°å­¦æˆç»©ä¼šç¨³æ­¥æå‡ã€‚`;
                
                return analysis;
            }

            formatRecommendations(recommendations) {
                if (recommendations.length === 0) {
                    return [
                        {
                            type: 'review',
                            title: 'åŸºç¡€å¤ä¹ ',
                            description: 'é‡ç‚¹å¤ä¹ æµ‹è¯„ä¸­çš„è–„å¼±çŸ¥è¯†ç‚¹'
                        },
                        {
                            type: 'practice',
                            title: 'ä¸“é¡¹ç»ƒä¹ ',
                            description: 'é’ˆå¯¹é”™è¯¯é¢˜å‹è¿›è¡Œä¸“é¡¹è®­ç»ƒ'
                        },
                        {
                            type: 'challenge',
                            title: 'èƒ½åŠ›æå‡',
                            description: 'å°è¯•æ›´é«˜éš¾åº¦çš„é¢˜ç›®ï¼Œæå‡ç»¼åˆèƒ½åŠ›'
                        }
                    ];
                }
                
                return recommendations.map(rec => {
                    if (typeof rec === 'string') {
                        return {
                            type: 'practice',
                            title: 'å­¦ä¹ å»ºè®®',
                            description: rec
                        };
                    }
                    return rec;
                });
            }

            generateKnowledgePointsFromData(score) {
                const basePoints = [
                    { name: 'æœ‰ç†æ•°æ¦‚å¿µ', questions: 2 },
                    { name: 'æœ‰ç†æ•°è¿ç®—', questions: 3 },
                    { name: 'ç»å¯¹å€¼', questions: 2 },
                    { name: 'æ•°è½´åº”ç”¨', questions: 1 }
                ];
                
                return basePoints.map((point, index) => {
                    // æ ¹æ®æ€»ä½“å¾—åˆ†å’Œéšæœºå› å­ç”Ÿæˆå„çŸ¥è¯†ç‚¹çš„æŒæ¡æƒ…å†µ
                    const randomFactor = 0.85 + (Math.sin(index) * 0.3); // ç”Ÿæˆä¸åŒçš„åˆ†å¸ƒ
                    const mastery = Math.min(1, Math.max(0.3, (score / 100) * randomFactor));
                    const correct = Math.round(point.questions * mastery);
                    
                    let status = 'needs-improvement';
                    if (mastery >= 0.85) status = 'excellent';
                    else if (mastery >= 0.7) status = 'good';
                    else if (mastery >= 0.5) status = 'normal';
                    
                    return {
                        name: point.name,
                        mastery: mastery,
                        status: status,
                        questions: point.questions,
                        correct: correct
                    };
                });
            }

            generateAbilities(score) {
                const factor = score / 100;
                // ä¸ºæ¯ä¸ªèƒ½åŠ›ç»´åº¦æ·»åŠ ä¸€äº›å˜åŒ–ï¼Œä½¿å…¶çœ‹èµ·æ¥æ›´çœŸå®
                const variations = [1.1, 0.95, 0.9, 1.15, 1.0];
                const baseScores = [80, 75, 70, 85, 78];
                
                return {
                    understanding: Math.min(100, Math.round(baseScores[0] * factor * variations[0])),
                    application: Math.min(100, Math.round(baseScores[1] * factor * variations[1])),
                    analysis: Math.min(100, Math.round(baseScores[2] * factor * variations[2])),
                    computation: Math.min(100, Math.round(baseScores[3] * factor * variations[3])),
                    logical: Math.min(100, Math.round(baseScores[4] * factor * variations[4]))
                };
            }

            generateOfflineReport(data) {
                const correctCount = data.answers?.filter(a => a.isCorrect).length || 0;
                const totalQuestions = data.answers?.length || 5;
                const accuracy = totalQuestions > 0 ? (correctCount / totalQuestions * 100) : 0;
                
                return {
                    overview: {
                        totalScore: 85,
                        correctRate: 80,
                        avgTime: 92, // ç§’
                        adaptiveDifficulty: 'medium'
                    },
                    knowledgePoints: [
                        {
                            name: 'æœ‰ç†æ•°æ¦‚å¿µ',
                            mastery: 0.85,
                            status: 'excellent',
                            questions: 2,
                            correct: 2
                        },
                        {
                            name: 'æœ‰ç†æ•°è¿ç®—',
                            mastery: 0.72,
                            status: 'good',
                            questions: 2,
                            correct: 1
                        },
                        {
                            name: 'ç»å¯¹å€¼',
                            mastery: 0.65,
                            status: 'needs-improvement',
                            questions: 1,
                            correct: 0
                        }
                    ],
                    abilities: {
                        understanding: 82,
                        application: 75,
                        analysis: 70,
                        computation: 88,
                        logical: 78
                    },
                    aiAnalysis: `
                        åŸºäºæœ¬æ¬¡æµ‹è¯„ç»“æœï¼Œç‹å°ååŒå­¦åœ¨æ•°å­¦å­¦ä¹ æ–¹é¢è¡¨ç°å‡ºä»¥ä¸‹ç‰¹ç‚¹ï¼š
                        
                        <strong>ä¼˜åŠ¿æ–¹é¢ï¼š</strong>
                        â€¢ å¯¹åŸºæœ¬æ¦‚å¿µçš„ç†è§£è¾ƒä¸ºæ‰å®ï¼Œç‰¹åˆ«æ˜¯æœ‰ç†æ•°æ¦‚å¿µæŒæ¡è‰¯å¥½
                        â€¢ è®¡ç®—èƒ½åŠ›è¾ƒå¼ºï¼ŒåŸºç¡€è¿ç®—å‡†ç¡®ç‡é«˜
                        â€¢ ç­”é¢˜æ—¶é—´æ§åˆ¶åˆç†ï¼Œæ€è€ƒè¿‡ç¨‹è¾ƒä¸ºå……åˆ†
                        
                        <strong>éœ€è¦æå‡çš„æ–¹é¢ï¼š</strong>
                        â€¢ ç»å¯¹å€¼ç›¸å…³æ¦‚å¿µéœ€è¦åŠ å¼ºç†è§£å’Œç»ƒä¹ 
                        â€¢ å¤æ‚è¿ç®—çš„å‡†ç¡®æ€§æœ‰å¾…æé«˜
                        â€¢ å¯ä»¥å°è¯•æŒ‘æˆ˜æ›´é«˜éš¾åº¦çš„é¢˜ç›®
                        
                        <strong>å­¦ä¹ å»ºè®®ï¼š</strong>
                        å»ºè®®é‡ç‚¹å¤ä¹ ç»å¯¹å€¼çš„å®šä¹‰å’Œæ€§è´¨ï¼Œå¤šåšç›¸å…³ç»ƒä¹ é¢˜ã€‚åŒæ—¶ä¿æŒç°æœ‰çš„å­¦ä¹ èŠ‚å¥ï¼Œé€æ­¥æå‡ç»¼åˆåº”ç”¨èƒ½åŠ›ã€‚
                    `,
                    recommendations: [
                        {
                            type: 'review',
                            title: 'é‡ç‚¹å¤ä¹ ç»å¯¹å€¼æ¦‚å¿µ',
                            description: 'å»ºè®®èŠ±è´¹1-2å¤©æ—¶é—´é‡æ–°å­¦ä¹ ç»å¯¹å€¼çš„å®šä¹‰ã€æ€§è´¨å’Œè®¡ç®—æ–¹æ³•',
                            priority: 'high'
                        },
                        {
                            type: 'practice',
                            title: 'å¢åŠ æœ‰ç†æ•°è¿ç®—ç»ƒä¹ ',
                            description: 'æ¯å¤©å®Œæˆ10-15é“æœ‰ç†æ•°æ··åˆè¿ç®—é¢˜ç›®ï¼Œæå‡è®¡ç®—å‡†ç¡®æ€§',
                            priority: 'medium'
                        },
                        {
                            type: 'challenge',
                            title: 'å°è¯•æ›´é«˜éš¾åº¦é¢˜ç›®',
                            description: 'åœ¨å·©å›ºåŸºç¡€åï¼Œå¯ä»¥å°è¯•ä¸€äº›ç»¼åˆæ€§è¾ƒå¼ºçš„åº”ç”¨é¢˜',
                            priority: 'low'
                        }
                    ],
                    learningPlan: {
                        shortTerm: [
                            'æœ¬å‘¨ï¼šé‡ç‚¹å¤ä¹ ç»å¯¹å€¼ç›¸å…³çŸ¥è¯†ç‚¹',
                            'ä¸‹å‘¨ï¼šåŠ å¼ºæœ‰ç†æ•°è¿ç®—ç»ƒä¹ '
                        ],
                        mediumTerm: [
                            'æœ¬æœˆï¼šå®Œæˆæœ‰ç†æ•°å•å…ƒçš„å…¨é¢å¤ä¹ ',
                            'ä¸‹æœˆï¼šå¼€å§‹æ•´å¼çš„å­¦ä¹ '
                        ]
                    }
                };
            }

            displayResult() {
                // æ˜¾ç¤ºæ¦‚è§ˆæ•°æ®
                this.totalScore.textContent = this.resultData.overview.totalScore;
                this.correctRate.textContent = this.resultData.overview.correctRate + '%';
                
                const minutes = Math.floor(this.resultData.overview.avgTime / 60);
                const seconds = this.resultData.overview.avgTime % 60;
                this.avgTime.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                const difficultyMap = {
                    'easy': 'ç®€å•',
                    'medium': 'ä¸­ç­‰',
                    'hard': 'å›°éš¾'
                };
                this.difficulty.textContent = difficultyMap[this.resultData.overview.adaptiveDifficulty];

                // æ˜¾ç¤ºçŸ¥è¯†ç‚¹æŒæ¡æƒ…å†µ
                this.displayKnowledgePoints();
                
                // æ˜¾ç¤ºAIåˆ†æ
                this.aiAnalysisContent.innerHTML = this.resultData.aiAnalysis;
                
                // æ˜¾ç¤ºå»ºè®®
                this.displayRecommendations();
                
                // æ˜¾ç¤ºå­¦ä¹ è§„åˆ’
                this.displayLearningPlan();
                
                // ç»˜åˆ¶èƒ½åŠ›é›·è¾¾å›¾
                this.drawAbilityChart();
            }

            displayKnowledgePoints() {
                this.knowledgePoints.innerHTML = '';
                
                this.resultData.knowledgePoints.forEach(point => {
                    const pointElement = document.createElement('div');
                    pointElement.className = `knowledge-point ${point.status}`;
                    
                    const percentage = Math.round(point.mastery * 100);
                    
                    pointElement.innerHTML = `
                        <div class="point-header">
                            <span class="point-name">${point.name}</span>
                            <span class="point-score">${percentage}%</span>
                        </div>
                        <div class="point-progress">
                            <div class="point-fill" style="width: ${percentage}%"></div>
                        </div>
                        <div class="point-status">
                            ${point.correct}/${point.questions} é¢˜æ­£ç¡®
                        </div>
                    `;
                    
                    this.knowledgePoints.appendChild(pointElement);
                });
            }

            displayRecommendations() {
                this.recommendations.innerHTML = '';
                
                this.resultData.recommendations.forEach(rec => {
                    const recElement = document.createElement('li');
                    recElement.className = 'recommendation-item';
                    
                    const iconMap = {
                        'review': 'refresh-cw',
                        'practice': 'edit-3',
                        'challenge': 'zap'
                    };
                    
                    recElement.innerHTML = `
                        <div class="rec-icon">
                            <i data-lucide="${iconMap[rec.type]}" size="12"></i>
                        </div>
                        <div>
                            <div style="font-weight: 600; margin-bottom: 4px;">${rec.title}</div>
                            <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">
                                ${rec.description}
                            </div>
                        </div>
                    `;
                    
                    this.recommendations.appendChild(recElement);
                });
                
                // é‡æ–°åˆå§‹åŒ–å›¾æ ‡
                lucide.createIcons();
            }

            displayLearningPlan() {
                this.learningPlan.innerHTML = `
                    <div style="margin-bottom: var(--space-lg);">
                        <h4 style="color: var(--primary-color); margin-bottom: var(--space-sm);">è¿‘æœŸè§„åˆ’</h4>
                        <ul style="list-style: none; padding: 0;">
                            ${this.resultData.learningPlan.shortTerm.map(item => `
                                <li style="display: flex; align-items: center; gap: var(--space-sm); margin-bottom: var(--space-sm);">
                                    <i data-lucide="check-circle" size="16" style="color: var(--success-color);"></i>
                                    <span style="font-size: var(--font-size-sm);">${item}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                    <div>
                        <h4 style="color: var(--primary-color); margin-bottom: var(--space-sm);">ä¸­æœŸç›®æ ‡</h4>
                        <ul style="list-style: none; padding: 0;">
                            ${this.resultData.learningPlan.mediumTerm.map(item => `
                                <li style="display: flex; align-items: center; gap: var(--space-sm); margin-bottom: var(--space-sm);">
                                    <i data-lucide="target" size="16" style="color: var(--primary-color);"></i>
                                    <span style="font-size: var(--font-size-sm);">${item}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
                
                lucide.createIcons();
            }

            drawAbilityChart() {
                const ctx = document.getElementById('abilityChart').getContext('2d');
                
                this.chart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: ['ç†è§£èƒ½åŠ›', 'åº”ç”¨èƒ½åŠ›', 'åˆ†æèƒ½åŠ›', 'è®¡ç®—èƒ½åŠ›', 'é€»è¾‘æ€ç»´'],
                        datasets: [{
                            label: 'å½“å‰æ°´å¹³',
                            data: [
                                this.resultData.abilities.understanding,
                                this.resultData.abilities.application,
                                this.resultData.abilities.analysis,
                                this.resultData.abilities.computation,
                                this.resultData.abilities.logical
                            ],
                            backgroundColor: 'rgba(107, 165, 57, 0.2)',
                            borderColor: 'rgba(107, 165, 57, 1)',
                            pointBackgroundColor: 'rgba(107, 165, 57, 1)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgba(107, 165, 57, 1)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            r: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    display: false
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                },
                                angleLines: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            }
                        }
                    }
                });
            }

            hideLoading() {
                this.loadingSection.style.display = 'none';
                this.resultContent.style.display = 'block';
            }

            showError() {
                this.loadingSection.innerHTML = `
                    <div style="text-align: center;">
                        <i data-lucide="alert-circle" size="48" style="color: var(--error-color); margin-bottom: var(--space-md);"></i>
                        <p>åŠ è½½æµ‹è¯„ç»“æœå¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</p>
                    </div>
                `;
                lucide.createIcons();
            }
        }

        // ç”Ÿæˆå­¦æƒ…ç™½çš®ä¹¦ï¼ˆå­¦æœŸå­¦ä¹ è§„åˆ’ï¼‰
        async function generateWhitepaper() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            
            btn.innerHTML = '<i data-lucide="loader" class="animate-spin"></i> ç”Ÿæˆä¸­...';
            btn.disabled = true;
            
            try {
                console.log('å¼€å§‹ç”Ÿæˆå­¦æƒ…æŠ¥å‘Š...');
                
                // è°ƒç”¨APIç”Ÿæˆå­¦æœŸå­¦ä¹ è§„åˆ’
                const response = await fetch(`${window.apiBaseUrl || ''}/api/semester-plan/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        studentId: 'student_001',
                        semester: 'æœ¬å­¦æœŸ',
                        subject: 'æ•°å­¦'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`ç”Ÿæˆå¤±è´¥: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('å­¦æœŸè§„åˆ’ç”ŸæˆæˆåŠŸ:', result.plan);
                    showPlanModal(result.plan);
                } else {
                    throw new Error(result.error || 'ç”Ÿæˆå¤±è´¥');
                }
                
            } catch (error) {
                console.error('ç”Ÿæˆå­¦æƒ…æŠ¥å‘Šå¤±è´¥:', error);
                alert('ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•ï¼š' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
                lucide.createIcons();
            }
        }

        // æ˜¾ç¤ºå­¦æœŸè§„åˆ’å¼¹çª—
        function showPlanModal(plan) {
            // åˆ›å»ºå¼¹çª—
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
                box-sizing: border-box;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                border-radius: 12px;
                max-width: 800px;
                max-height: 90%;
                overflow-y: auto;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
                position: relative;
            `;
            
            modalContent.innerHTML = `
                <div style="padding: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; border-bottom: 1px solid #eee; padding-bottom: 16px;">
                        <h2 style="margin: 0; color: #333; font-size: 24px;">ğŸ“Š AIå­¦æœŸå­¦ä¹ è§„åˆ’</h2>
                        <button onclick="this.closest('.modal-overlay').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">Ã—</button>
                    </div>
                    
                    <div style="space-y: 20px;">
                        <!-- æ•´ä½“è¡¨ç° -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="color: #6ba539; margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                                <i data-lucide="trending-up" size="20"></i>
                                æ•´ä½“è¡¨ç°åˆ†æ
                            </h3>
                            <p style="margin: 0; line-height: 1.6; color: #555;">${plan.overall_performance}</p>
                        </div>

                        <!-- å­¦ä¹ ç›®æ ‡ -->
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #6ba539; margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                                <i data-lucide="target" size="20"></i>
                                å­¦ä¹ ç›®æ ‡
                            </h3>
                            <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                                ${plan.learning_goals.map(goal => `<li style="margin-bottom: 8px; color: #555;">${goal}</li>`).join('')}
                            </ul>
                        </div>

                        <!-- å­¦ä¹ å®‰æ’ -->
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #6ba539; margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                                <i data-lucide="calendar" size="20"></i>
                                å­¦ä¹ å®‰æ’
                            </h3>
                            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px;">
                                <div style="margin-bottom: 16px;">
                                    <h4 style="margin: 0 0 8px 0; color: #374151;">æ¯å‘¨è®¡åˆ’</h4>
                                    <ul style="margin: 0; padding-left: 20px; line-height: 1.6;">
                                        ${plan.study_schedule.weekly_plan.map(item => `<li style="margin-bottom: 4px; color: #555;">${item}</li>`).join('')}
                                    </ul>
                                </div>
                                <div style="margin-bottom: 16px;">
                                    <h4 style="margin: 0 0 8px 0; color: #374151;">æ¯æœˆé‡Œç¨‹ç¢‘</h4>
                                    <ul style="margin: 0; padding-left: 20px; line-height: 1.6;">
                                        ${plan.study_schedule.monthly_milestones.map(item => `<li style="margin-bottom: 4px; color: #555;">${item}</li>`).join('')}
                                    </ul>
                                </div>
                                <div>
                                    <h4 style="margin: 0 0 8px 0; color: #374151;">æ¯æ—¥ç»ƒä¹ </h4>
                                    <ul style="margin: 0; padding-left: 20px; line-height: 1.6;">
                                        ${plan.study_schedule.daily_practice.map(item => `<li style="margin-bottom: 4px; color: #555;">${item}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- é‡ç‚¹æå‡ -->
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #6ba539; margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                                <i data-lucide="zap" size="20"></i>
                                é‡ç‚¹æå‡é¢†åŸŸ
                            </h3>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                ${plan.key_improvements.map(item => `
                                    <span style="background: #6ba539; color: white; padding: 6px 12px; border-radius: 16px; font-size: 14px;">${item}</span>
                                `).join('')}
                            </div>
                        </div>

                        <!-- AIåˆ†æ -->
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="color: white; margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                                <i data-lucide="brain" size="20"></i>
                                AIæ·±åº¦åˆ†æ
                            </h3>
                            <p style="margin: 0; line-height: 1.6; font-size: 15px;">${plan.ai_analysis}</p>
                        </div>

                        <!-- æ“ä½œæŒ‰é’® -->
                        <div style="display: flex; gap: 12px; justify-content: center; padding-top: 20px; border-top: 1px solid #eee;">
                            <button onclick="window.print()" style="background: #6ba539; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                <i data-lucide="printer" size="16"></i>
                                æ‰“å°è§„åˆ’
                            </button>
                            <button onclick="this.closest('.modal-overlay').remove()" style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                <i data-lucide="x" size="16"></i>
                                å…³é—­
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // é‡æ–°åˆå§‹åŒ–å›¾æ ‡
            lucide.createIcons();
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            // ESCé”®å…³é—­
            document.addEventListener('keydown', function escHandler(e) {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', escHandler);
                }
            });
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            new AssessmentResult();
        });
    </script>
</body>
</html> 